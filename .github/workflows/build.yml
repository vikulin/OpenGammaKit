name: KiCad Fabrication Workflow

on:
  push:
    tags:
      - '*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install KiCad
        run: |
          sudo add-apt-repository --yes ppa:kicad/kicad-8.0-releases
          sudo apt update
          sudo apt install --yes kicad

      - name: Generate Gerber, Drill, and Centroid Files
        run: |
          mkdir -p fabrication-outputs/gerber-files
          mkdir -p fabrication-outputs/centroid-files

          # Generate Gerber files in Gerber X2 format
          kicad-cli pcb export gerbers gamma-spectrometer.kicad_pro \
            -o fabrication-outputs/gerber-files/gamma-spectrometer \
            --include-border-title \
            --precision 6

          # Generate drill files (in Gerber X2 format)
          kicad-cli pcb export drill gamma-spectrometer.kicad_pro \
            -o fabrication-outputs/gerber-files/gamma-spectrometer.drl \
            --format gerberx2 \
            --map-format gerberx2

          # Generate centroid (POS) file in mils
          kicad-cli pcb export pos gamma-spectrometer.kicad_pro \
            -o fabrication-outputs/centroid-files/centroid.csv \
            --format csv \
            --units mils \
            --origin drill

          # Format centroid CSV with aligned columns
          column -t -s, fabrication-outputs/centroid-files/centroid.csv > fabrication-outputs/centroid-files/centroid-aligned.txt
          mv fabrication-outputs/centroid-files/centroid-aligned.txt fabrication-outputs/centroid-files/centroid.csv

      - name: Archive Gerber Files
        if: github.ref_type == 'tag'
        run: |
          mkdir -p build
          zip -r build/open-gamma-kit-gerber-files-${{ github.ref_name }}.zip fabrication-outputs/gerber-files

      - name: Archive Centroid Files
        if: github.ref_type == 'tag'
        run: |
          zip -r build/open-gamma-kit-centroid-files-${{ github.ref_name }}.zip fabrication-outputs/centroid-files

      - name: Archive Documentation Files
        if: github.ref_type == 'tag'
        run: |
          zip -j build/README.zip docs/gamma-spectrometer.pdf README.md

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ogk-release-${{ github.ref_name }}
          path: |
            build/open-gamma-kit-gerber-files-${{ github.ref_name }}.zip
            build/open-gamma-kit-centroid-files-${{ github.ref_name }}.zip
            build/README.zip
            docs/BOM.csv

      - name: Generate Changelog Since Last Tag
        if: github.ref_type == 'tag'
        run: |
          echo "" > RELEASE_BODY.md
          echo "## What's Changed" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          git log -n 10 --pretty=format:"- %s" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "---" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "ðŸ”§ Thanks for supporting OpenGammaKit! If you find any issues or have suggestions, feel free to [open an issue](https://github.com/${{ github.repository }}/issues)." >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "### ðŸ“¦ Release Contents" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "| File Name | Description |" >> RELEASE_BODY.md
          echo "|-----------|-------------|" >> RELEASE_BODY.md
          echo "| \`open-gamma-kit-gerber-files-${{ github.ref_name }}.zip\` | ðŸŸ¢ Complete Gerber and Drill files (Gerber X2 format) for PCB fabrication. |" >> RELEASE_BODY.md
          echo "| \`open-gamma-kit-centroid-files-${{ github.ref_name }}.zip\` | ðŸ“ Centroid (Pick-and-Place) file in mils for automated assembly. |" >> RELEASE_BODY.md
          echo "| \`README.zip\` | ðŸ“„ PDF documentation + README.md. |" >> RELEASE_BODY.md
          echo "| \`BOM.csv\` | ðŸ“‹ Bill of Materials. |" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "ðŸ“ **Location**: All files are available in the [Assets](#assets) section at the bottom of this release page." >> RELEASE_BODY.md

      - name: Create GitHub Release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          name: OpenGammaKit ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          body_path: RELEASE_BODY.md
          files: |
            build/open-gamma-kit-gerber-files-${{ github.ref_name }}.zip
            build/open-gamma-kit-centroid-files-${{ github.ref_name }}.zip
            build/README.zip
            docs/BOM.csv
        env:
          GITHUB_TOKEN: ${{ secrets.CUSTOM_GITHUB_TOKEN }}
